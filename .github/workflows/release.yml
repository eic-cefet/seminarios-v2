name: Release

on:
  push:
    branches: [main]

jobs:
  test-and-release:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: testing
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      # Generate GitHub App token for bot identity
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      # Setup PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, pdo_mysql, bcmath, intl, gd, exif, iconv
          coverage: pcov

      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: Get composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Install composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Install pnpm dependencies
        run: pnpm install --frozen-lockfile

      - name: Run frontend tests with coverage
        run: pnpm test:coverage

      - name: Upload frontend coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/coverage-final.json
          flags: frontend
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Build frontend assets
        run: pnpm run build

      - name: Copy environment file
        run: cp .env.example .env

      - name: Generate application key
        run: php artisan key:generate

      - name: Run tests with coverage
        run: php artisan test --compact --coverage-clover=coverage/backend-clover.xml
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: password

      - name: Upload backend coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/backend-clover.xml
          flags: backend
          token: ${{ secrets.CODECOV_TOKEN }}

      # Get PR info and create tag
      - name: Get merged PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 5
            });

            const mergedPR = prs.find(pr => pr.merge_commit_sha === context.sha);
            if (!mergedPR) {
              console.log('No merged PR found for this commit - skipping version bump');
              core.setOutput('found', 'false');
              return;
            }

            core.setOutput('found', 'true');
            core.setOutput('body', mergedPR.body || '');

      - name: Parse version bump
        if: steps.pr.outputs.found == 'true'
        id: version
        run: |
          BODY='${{ steps.pr.outputs.body }}'
          # Match key=value format: version_bump=VALUE
          BUMP=$(echo "$BODY" | grep -oiE 'version_bump=(patch|minor|major)' | cut -d'=' -f2 | head -1 | tr '[:upper:]' '[:lower:]')
          if [ -z "$BUMP" ]; then
            BUMP="patch"
          fi
          echo "Detected version bump: $BUMP"
          echo "bump=$BUMP" >> $GITHUB_OUTPUT

      - name: Get latest tag and calculate new version
        if: steps.pr.outputs.found == 'true'
        id: new-version
        run: |
          LATEST=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Current version: $LATEST"

          # Remove 'v' prefix and split
          VERSION=${LATEST#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          case "${{ steps.version.outputs.bump }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Create and push tag
        if: steps.pr.outputs.found == 'true'
        run: |
          git config user.name "seminarios-bot[bot]"
          git config user.email "seminarios-bot[bot]@users.noreply.github.com"
          git tag -a "${{ steps.new-version.outputs.version }}" -m "Release ${{ steps.new-version.outputs.version }}"
          git push origin "${{ steps.new-version.outputs.version }}"
